<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil - Oficina Mecânica Fossa</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --azul-escuro: #0a1f3d;
      --amarelo: #ffc107;
      --amarelo-claro: #fff3cd;
      --branco: #ffffff;
      --cinza: #f8f9fa;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--cinza);
      color: var(--azul-escuro);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER ESTILO CORRETO */
    header {
      background-color: var(--azul-escuro);
      color: var(--amarelo);
      padding: 1rem 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--amarelo);
      text-decoration: none;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .nav-links a {
      color: var(--branco);
      text-decoration: none;
      transition: color 0.3s;
      padding: 8px 12px;
      border-radius: 4px;
    }

    .nav-links a:hover {
      color: var(--amarelo);
      background-color: rgba(255, 255, 255, 0.1);
    }

    .nav-links a.btn-login {
      background-color: var(--amarelo);
      color: var(--azul-escuro);
      font-weight: bold;
      padding: 8px 15px;
    }

    .nav-links a.btn-login:hover {
      background-color: #e0a800;
      color: var(--azul-escuro);
    }

    .nav-links a.btn-cadastro {
      background-color: var(--amarelo);
      color: var(--azul-escuro);
      font-weight: bold;
      padding: 8px 15px;
    }

    .nav-links a.btn-cadastro:hover {
      background-color: #e0a800;
      color: var(--azul-escuro);
    }

    .user-dropdown {
      position: relative;
      display: inline-block;
    }

    .icone-perfil {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--amarelo);
        }

    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      min-width: 160px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 5px;
      overflow: hidden;
    }

    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
    }

    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .user-dropdown:hover .dropdown-content {
      display: block;
    }

    /* CONTEÚDO PRINCIPAL */
    main {
      flex: 1;
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .perfil-container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .perfil-container {
        grid-template-columns: 1fr;
      }
      
      .nav-links {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    .perfil-card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .perfil-header {
      margin-bottom: 20px;
    }

    .perfil-info h2 {
      margin: 0;
      color: var(--azul-escuro);
      font-size: 1.5rem;
    }

    .perfil-info p {
      margin: 5px 0;
      color: #666;
    }

    .btn-editar {
      background: var(--azul-escuro);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      transition: background 0.3s;
    }

    .btn-editar:hover {
      background: #08214e;
    }

    .info-pessoal h3 {
      color: var(--azul-escuro);
      border-bottom: 2px solid var(--amarelo);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .info-pessoal p {
      margin: 10px 0;
    }

    .info-pessoal strong {
      color: var(--azul-escuro);
    }

    .carros-lista, .agendamentos-lista {
      margin-top: 20px;
    }

    .carro-item, .agendamento-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--amarelo);
    }

    .carro-info h4, .agendamento-info h4 {
      margin: 0 0 5px 0;
      color: var(--azul-escuro);
    }

    .carro-info p, .agendamento-info p {
      margin: 3px 0;
      color: #666;
    }

    .carro-acoes, .agendamento-acoes {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn-excluir {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-excluir:hover {
      background: #c82333;
    }

    .btn-agendar {
      background: var(--amarelo);
      color: var(--azul-escuro);
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      text-decoration: none;
      display: inline-block;
      margin-top: 15px;
      transition: background 0.3s;
    }

    .btn-agendar:hover {
      background: #e0a800;
    }

    .sem-agendamentos, .sem-carros {
      text-align: center;
      padding: 30px;
      color: #666;
      font-style: italic;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .sem-carros a {
      color: var(--amarelo);
      font-weight: bold;
      text-decoration: none;
    }

    .sem-carros a:hover {
      text-decoration: underline;
    }

    /* RODAPÉ ESTILO CORRETO */
    footer {
      background-color: var(--azul-escuro);
      color: var(--branco);
      text-align: center;
      padding: 2rem 0;
      margin-top: 2rem;
    }

    footer p {
      margin: 5px 0;
    }

    /* Modal simplificado */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .modal-content {
      background-color: white;
      margin: 40px auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .fechar {
      color: #aaa;
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .fechar:hover {
      color: #000;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--azul-escuro);
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .form-group input:focus, .form-group textarea:focus {
      border-color: var(--azul-escuro);
      outline: none;
    }

    .btn-salvar {
      background: var(--azul-escuro);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      width: 100%;
      transition: background 0.3s;
    }

    .btn-salvar:hover {
      background: #08214e;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .loading::after {
      content: "...";
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }

    .status-agendado {
      color: #28a745;
      font-weight: bold;
    }

    .status-cancelado {
      color: #dc3545;
      font-weight: bold;
    }

    .status-concluido {
      color: #17a2b8;
      font-weight: bold;
    }

    .btn-excluir-agendamento {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: 10px;
    }

    .btn-excluir-agendamento:hover {
      background: #c82333;
    }


    .whatsapp-btn {
            display: inline-flex;
            align-items: center;
            background-color: #25D366;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
        }

        .whatsapp-btn i {
            margin-right: 8px;
        }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html" class="logo">Auto Peças Fossa</a>
      <div class="nav-links">
        <a href="index.html">Início</a>
        <a href="servicos.html">Serviços</a>
        <a href="produtos.html">Produtos</a>
        <div id="auth-buttons">
          <!-- Será preenchido via JavaScript -->
        </div>
        <div id="user-menu" style="display:none;">
          <div class="user-dropdown">
            <img src="imagens/imagem.oficina.icone.jpg" alt="Perfil" class="icone-perfil" id="user-icon">
            <div class="dropdown-content">
              <a href="perfil-completo.html">Meu Perfil</a>
              <a href="perfil.html">Cadastrar Carro</a>
              <a href="#" id="logout-btn">Sair</a>
            </div>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main>
    <div class="container">
      <h1>Meu Perfil</h1>
      
      <div class="perfil-container">
        <div class="perfil-card">
          <div class="perfil-header">
            <div class="perfil-info">
              <h2 id="user-nome">NICOLAS BIFF</h2>
              <p id="user-email">biffnicolas7@gmail.com</p>
              <button class="btn-editar" onclick="abrirModalEditarPerfil()">
                <i class="fas fa-edit"></i> Editar Perfil
              </button>
            </div>
          </div>
          
          <div class="info-pessoal">
            <h3>Informações Pessoais</h3>
            <p><strong>Telefone:</strong> <span id="user-telefone">47991632577</span></p>
            <p><strong>CPF:</strong> <span id="user-cpf">133.003.259-43</span></p>
          </div>

          <a href="agendamento.html" class="btn-agendar">
            <i class="fas fa-calendar-plus"></i> Fazer Novo Agendamento
          </a>
        </div>
        
        <div class="perfil-card">
          <h2>Meus Agendamentos</h2>
          <div class="agendamentos-lista" id="agendamentos-lista">
            <div class="loading">Carregando agendamentos</div>
          </div>
          
          <h2>Meus Carros</h2>
          <div class="carros-lista" id="carros-lista">
            <div class="loading">Carregando carros</div>
          </div>
          
          <a href="perfil.html" class="btn-agendar">
            <i class="fas fa-plus"></i> Cadastrar Novo Carro
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Editar Perfil Simplificado -->
  <div id="modal-editar-perfil" class="modal">
    <div class="modal-content">
      <span class="fechar" onclick="fecharModalEditarPerfil()">&times;</span>
      <h2>Editar Perfil</h2>
      <form id="form-editar-perfil">
        <div class="form-group">
          <label for="edit-nome">Nome</label>
          <input type="text" id="edit-nome" name="nome" value="NICOLAS BIFF" required>
        </div>
        <div class="form-group">
          <label for="edit-telefone">Telefone</label>
          <input type="text" id="edit-telefone" name="telefone" value="47991632577" required>
        </div>
        <div class="form-group">
          <label for="edit-senha">Nova Senha (deixe em branco para não alterar)</label>
          <input type="password" id="edit-senha" name="senha" placeholder="Nova senha">
        </div>
        <div class="form-group">
          <label for="edit-confirmar-senha">Confirmar Nova Senha</label>
          <input type="password" id="edit-confirmar-senha" name="confirmar_senha" placeholder="Confirmar nova senha">
        </div>
        <button type="submit" class="btn-salvar">Salvar Alterações</button>
      </form>
    </div>
  </div>

  <footer>
    <p>Oficina Mecânica Fossa &copy; 2025 - Todos os direitos reservados</p>
    <p>Endereço: Rua Marquês do Herval, 266 - Bairro Centro - Ibirama/SC</p>
    <p>Telefone: (47) 3357-3700</p>
    <a href="https://wa.me/5547988213642" class="whatsapp-btn" target="_blank">
        <i class="fab fa-whatsapp"></i> WhatsApp: (47) 98821-3642
    </a>
</footer>

  <script>
    // ===== FUNÇÕES PRINCIPAIS =====
    
    // Verificar status de login e atualizar header
    function checkLoginStatus() {
      const authSection = document.getElementById('auth-buttons');
      const userMenu = document.getElementById('user-menu');
      
      // Verificar se o usuário está logado
      const usuarioLogado = localStorage.getItem('usuario_logado') || sessionStorage.getItem('usuario_logado');
      
      if (usuarioLogado) {
        // Usuário logado - mostrar menu do usuário
        authSection.style.display = 'none';
        userMenu.style.display = 'block';
        
        try {
          const usuario = JSON.parse(usuarioLogado);
          document.getElementById('user-icon').innerHTML = `<i class="fas fa-user"></i>`;
        } catch (e) {
          console.error('Erro ao parsear dados do usuário:', e);
        }
      } else {
        // Usuário não logado - mostrar botões de login/cadastro
        authSection.innerHTML = `
          <a href="login.html" class="btn-login">Login</a>
          <a href="cadastro.html" class="btn-cadastro">Cadastre-se</a>
        `;
        authSection.style.display = 'flex';
        authSection.style.gap = '15px';
        authSection.style.alignItems = 'center';
        userMenu.style.display = 'none';
      }
    }
    
    // Carregar dados do usuário
    function carregarDadosUsuario() {
      try {
        const usuarioLogado = localStorage.getItem('usuario_logado') || sessionStorage.getItem('usuario_logado');
        
        if (usuarioLogado) {
          const usuario = JSON.parse(usuarioLogado);
          
          // Preencher informações do usuário
          document.getElementById('user-nome').textContent = usuario.nome;
          document.getElementById('user-email').textContent = usuario.email;
          document.getElementById('user-telefone').textContent = usuario.telefone;
          document.getElementById('user-cpf').textContent = usuario.cpf;
          
          // Preencher formulário de edição
          document.getElementById('edit-nome').value = usuario.nome;
          document.getElementById('edit-telefone').value = usuario.telefone;
        } else {
          alert('Você precisa estar logado para acessar esta página!');
          window.location.href = 'login.html';
        }
      } catch (error) {
        console.error('Erro ao carregar dados do usuário:', error);
      }
    }

    // Carregar carros do usuário
    async function carregarCarrosUsuario() {
      try {
        const response = await fetch('get_carro.php', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar carros: ' + response.status);
        }
        
        const dados = await response.json();
        const listaCarros = document.getElementById('carros-lista');
        
        if (dados.success && dados.data && dados.data.length > 0) {
          let html = '';
          dados.data.forEach(carro => {
            html += `
              <div class="carro-item">
                <div class="carro-info">
                  <h4>${carro.marca} ${carro.modelo} (${carro.ano})</h4>
                  <p>Placa: ${carro.placa} | Cor: ${carro.cor || 'Não informada'}</p>
                  <p>Combustível: ${carro.combustivel} | Quilometragem: ${carro.km} km</p>
                </div>
                <div class="carro-acoes">
                  <button class="btn-excluir" onclick="excluirCarro(${carro.id})">
                    <i class="fas fa-trash"></i> Excluir
                  </button>
                </div>
              </div>
            `;
          });
          listaCarros.innerHTML = html;
        } else {
          listaCarros.innerHTML = `
            <div class="sem-carros">
              <p>Nenhum carro cadastrado.</p>
              <p><a href="perfil.html">Clique aqui para cadastrar seu primeiro carro</a></p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erro ao carregar carros:', error);
        document.getElementById('carros-lista').innerHTML = `
          <div class="sem-carros">
            <p>Erro ao carregar carros. <button onclick="carregarCarrosUsuario()">Tentar novamente</button></p>
          </div>
        `;
      }
    }

    // Carregar agendamentos do usuário
    async function carregarAgendamentosUsuario() {
      try {
        console.log("Carregando agendamentos...");
        const response = await fetch('get_agendamentos.php', {
          credentials: 'include'
        });
        
        // Verificar se a resposta é OK
        if (!response.ok) {
          if (response.status === 401) {
            // Não autorizado - redirecionar para login
            localStorage.removeItem('usuario_logado');
            sessionStorage.removeItem('usuario_logado');
            alert('Sessão expirada. Por favor, faça login novamente.');
            window.location.href = 'login.html';
            return;
          }
          throw new Error(`Erro ${response.status}: ${response.statusText}`);
        }
        
        // Verificar se a resposta é JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const textResponse = await response.text();
          console.error("Resposta não é JSON:", textResponse.substring(0, 200));
          throw new Error('Resposta do servidor não é JSON.');
        }
        
        const dados = await response.json();
        console.log("Dados de agendamentos:", dados);
        
        const listaAgendamentos = document.getElementById('agendamentos-lista');
        
        // Verificar se há erro na resposta
        if (dados.error) {
          throw new Error(dados.error + (dados.message ? ': ' + dados.message : ''));
        }
        
        // Verificar se temos dados
        if (!dados.success) {
          throw new Error(dados.message || 'Erro ao carregar agendamentos');
        }
        
        const agendamentos = dados.data || [];
        
        if (agendamentos.length === 0) {
          listaAgendamentos.innerHTML = `
            <div class="sem-agendamentos">
              <p>Nenhum agendamento encontrado.</p>
              <p><a href="agendamento.html">Clique aqui para fazer seu primeiro agendamento</a></p>
            </div>
          `;
          return;
        }
        
        let html = '';
        agendamentos.forEach(agendamento => {
          // Formatar data
          const dataObj = new Date(agendamento.data + 'T00:00:00');
          const dataFormatada = dataObj.toLocaleDateString('pt-BR');
          
          // Cor baseada no status
          let classeStatus = 'status-agendado';
          if (agendamento.status === 'cancelado') classeStatus = 'status-cancelado';
          if (agendamento.status === 'concluido') classeStatus = 'status-concluido';
          
          html += `
            <div class="agendamento-item">
              <div class="agendamento-info">
                <h4>${agendamento.mecanico}</h4>
                <p><strong>Data:</strong> ${dataFormatada}</p>
                <p><strong>Carro:</strong> ${agendamento.marca} ${agendamento.modelo} - ${agendamento.placa}</p>
                <p><strong>Status:</strong> <span class="${classeStatus}">${agendamento.status}</span></p>
                <p><strong>Descrição:</strong> ${agendamento.descricao}</p>
              </div>
              <div class="agendamento-acoes">
                ${agendamento.status === 'agendado' ? `
                  <button class="btn-excluir" onclick="cancelarAgendamento(${agendamento.id})">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                ` : ''}
                <button class="btn-excluir" onclick="excluirAgendamento(${agendamento.id})" style="background: #dc3545;">
                  <i class="fas fa-trash"></i> Excluir
                  </button>
              </div>
            </div>
          `;
        });
        
        listaAgendamentos.innerHTML = html;
        
      } catch (error) {
        console.error('Erro ao carregar agendamentos:', error);
        document.getElementById('agendamentos-lista').innerHTML = `
          <div class="sem-agendamentos">
            <p>Erro ao carregar agendamentos: ${error.message}</p>
            <p><button onclick="carregarAgendamentosUsuario()" style="
              background: var(--azul-escuro);
              color: white;
              border: none;
              padding: 10px 15px;
              border-radius: 4px;
              cursor: pointer;
              margin-top: 10px;
            ">Tentar novamente</button></p>
          </div>
        `;
      }
    }

    // ===== FUNÇÕES DO MODAL =====
    
    function abrirModalEditarPerfil() {
      document.getElementById('modal-editar-perfil').style.display = 'block';
    }

    function fecharModalEditarPerfil() {
      document.getElementById('modal-editar-perfil').style.display = 'none';
    }

    // ===== EVENT LISTENERS =====
    
    document.getElementById('form-editar-perfil').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const btnSubmit = this.querySelector('button[type="submit"]');
      
      try {
        btnSubmit.disabled = true;
        btnSubmit.textContent = 'Salvando...';
        
        const response = await fetch('editar_perfil.php', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        
        const result = await response.text();
        
        if (result === 'success') {
          alert('Perfil atualizado com sucesso!');
          fecharModalEditarPerfil();
          
          // Recarregar dados do usuário
          const usuarioLogado = localStorage.getItem('usuario_logado') || sessionStorage.getItem('usuario_logado');
          if (usuarioLogado) {
            const usuario = JSON.parse(usuarioLogado);
            usuario.nome = document.getElementById('edit-nome').value;
            usuario.telefone = document.getElementById('edit-telefone').value;
            
            localStorage.setItem('usuario_logado', JSON.stringify(usuario));
            sessionStorage.setItem('usuario_logado', JSON.stringify(usuario));
            
            carregarDadosUsuario();
          }
        } else {
          alert('Erro ao atualizar perfil: ' + result);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao atualizar perfil.');
      } finally {
        btnSubmit.disabled = false;
        btnSubmit.textContent = 'Salvar Alterações';
      }
    });

    // Fechar modal ao clicar fora dele
    window.addEventListener('click', function(e) {
      const modal = document.getElementById('modal-editar-perfil');
      if (e.target === modal) {
        fecharModalEditarPerfil();
      }
    });

    // ===== INICIALIZAÇÃO =====
    
    document.addEventListener('DOMContentLoaded', function() {
      // Configurar navbar
      checkLoginStatus();
      
      // Carregar dados do usuário
      carregarDadosUsuario();
      carregarCarrosUsuario();
      carregarAgendamentosUsuario();
      
      // Configurar logout
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          localStorage.removeItem('usuario_logado');
          sessionStorage.removeItem('usuario_logado');
          window.location.href = 'index.html';
        });
      }
    });

    // ===== FUNÇÕES AUXILIARES =====
    
    async function excluirCarro(carroId) {
      if (!confirm('Tem certeza que deseja excluir este carro?')) return;
      
      try {
        const response = await fetch('excluir_carro.php', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id: carroId }),
          credentials: 'include'
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Carro excluído com sucesso!');
          carregarCarrosUsuario();
        } else {
          alert('Erro ao excluir carro: ' + result.message);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao excluir carro. Verifique sua conexão e tente novamente.');
      }
    }

    async function cancelarAgendamento(agendamentoId) {
      if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;
      
      try {
        const response = await fetch('cancelar_agendamento.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id: agendamentoId }),
          credentials: 'include'
        });
        
        // Verificar se a resposta é JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const textResponse = await response.text();
          throw new Error('Resposta do servidor não é JSON: ' + textResponse);
        }
        
        const result = await response.json();
        
        if (result.success) {
          alert('Agendamento cancelado com sucesso!');
          carregarAgendamentosUsuario(); // Recarregar a lista
        } else {
          alert('Erro ao cancelar agendamento: ' + (result.error || result.message));
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao cancelar agendamento: ' + error.message);
      }
    }

    // Função para excluir agendamento (corrigida)
    async function excluirAgendamento(agendamentoId) {
      if (!confirm('Tem certeza que deseja excluir permanentemente este agendamento?')) return;
      
      try {
        const response = await fetch('excluir_agendamento.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id: agendamentoId }),
          credentials: 'include'
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Agendamento excluído com sucesso!');
          carregarAgendamentosUsuario(); // Recarregar a lista
        } else {
          alert('Erro ao excluir agendamento: ' + result.error);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao excluir agendamento. Verifique sua conexão e tente novamente.');
      }
    }
  </script>
</body>
</html>